<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Vocal Price App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial; padding: 10px; text-align: center; background-color: #f0f0f0; -webkit-user-select: none; user-select: none; }
        button { padding: 10px 20px; margin: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; touch-action: manipulation; }
        input { margin: 10px; }
        #status { color: #333; }
        label { display: block; margin: 10px; }
        #lotDisplay { margin: 20px; padding: 10px; border: 1px solid #ccc; background-color: #fff; min-height: 50px; font-size: 16px; word-wrap: break-word; }
        input[type="range"] { width: 80%; }
        .red { color: red; font-weight: bold; }
        footer { font-size: 12px; color: #666; margin-top: 20px; padding: 10px; border-top: 1px solid #ccc; }
        #logo { width: 200px; margin: 10px auto; display: block; }
        #helpIcon { position: fixed; bottom: 10px; right: 10px; background-color: #007bff; color: white; width: 30px; height: 30px; border-radius: 50%; text-align: center; line-height: 30px; cursor: pointer; font-size: 20px; }
        #modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        #modalContent { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; text-align: center; }
        #closeModal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #exampleImage { max-width: 100%; height: auto; }
        select { padding: 10px; margin: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Vocal Price App</h1>
    <input type="file" id="priceFile" accept=".csv,.xlsx">
    <button onclick="vibrate(); loadPrice()">Загрузить прайс</button>
    <button onclick="vibrate(); clearStorage()">Очистить сохранённый прайс</button>
    <label>
        <input type="checkbox" id="priceOnly" checked> Только цена (без названия лота)
    </label>
    <label>
        Скорость произношения:
        <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="1.5">
        <span id="rateValue">1.5</span>
    </label>
    <label>
        Голос диктора:
        <select id="voiceSelect"></select>
    </label>
    <button onclick="vibrate(); startListening()">Начать прослушивание</button>
    <button onclick="vibrate(); stopListening()">Остановить</button>
    <p id="status">Статус: Загрузи прайс</p>
    <div id="lotDisplay">Название лота появится здесь</div>

    <footer>
        Разработано UGN, версия 1.24
        <img id="logo" src="logo.png" alt="Optimum Logo">
    </footer>

    <div id="helpIcon" onclick="vibrate(); showModal()">?</div>

    <div id="modal" onclick="closeModal()">
        <div id="modalContent" onclick="event.stopPropagation();">
            <span id="closeModal" onclick="closeModal()">&times;</span>
            <img id="exampleImage" src="example_excel.png" alt="Образец Excel">
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let priceDict = {};
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ru-RU';
        recognition.continuous = false;
        recognition.interimResults = false;

        let isListening = false;
        let lastResultTime = 0;
        const debounceTime = 1500;

        // Загрузка сохранённого прайса из localStorage при запуске
        if (localStorage.getItem('priceDict')) {
            priceDict = JSON.parse(localStorage.getItem('priceDict'));
            document.getElementById('status').textContent = 'Прайс загружен из памяти!';
        }

        // Обновление значения скорости
        const rateSlider = document.getElementById('speechRate');
        const rateValue = document.getElementById('rateValue');
        rateSlider.addEventListener('input', () => {
            rateValue.textContent = rateSlider.value;
        });

        // Загрузка сохранённой скорости
        if (localStorage.getItem('speechRate')) {
            rateSlider.value = localStorage.getItem('speechRate');
            rateValue.textContent = rateSlider.value;
        }

        // Сохранение скорости при изменении
        rateSlider.addEventListener('change', () => {
            localStorage.setItem('speechRate', rateSlider.value);
        });

        // Выбор голоса (только ru-RU)
        const voiceSelect = document.getElementById('voiceSelect');
        function loadVoices() {
            const voices = speechSynthesis.getVoices().filter(voice => voice.lang === 'ru-RU');
            voiceSelect.innerHTML = '';
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.textContent = voice.name + ' (' + voice.lang + ')';
                option.value = index;
                voiceSelect.appendChild(option);
            });
            if (voices.length > 0) {
                voiceSelect.value = 0;  // По умолчанию первый русский голос
            }
        }
        speechSynthesis.addEventListener('voiceschanged', loadVoices);
        loadVoices();

        // Загрузка сохранённого голоса
        if (localStorage.getItem('voiceIndex')) {
            voiceSelect.value = localStorage.getItem('voiceIndex');
        }

        // Сохранение голоса при изменении
        voiceSelect.addEventListener('change', () => {
            localStorage.setItem('voiceIndex', voiceSelect.value);
        });

        function clearStorage() {
            localStorage.removeItem('priceDict');
            priceDict = {};
            document.getElementById('status').textContent = 'Сохранённый прайс очищен. Загрузите новый.';
        }

        function loadPrice() {
            const file = document.getElementById('priceFile').files[0];
            if (!file) return alert('Выберите файл');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.csv')) {
                        Papa.parse(e.target.result, {
                            header: true,
                            complete: function(results) {
                                processData(results.data);
                            }
                        });
                    } else if (file.name.endsWith('.xlsx')) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets['Прайс-лист'] || workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);
                        processData(json);
                    }
                    document.getElementById('status').textContent = 'Прайс загружен!';
                    localStorage.setItem('priceDict', JSON.stringify(priceDict));  // Сохраняем в память
                } catch (err) {
                    alert('Ошибка загрузки: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            priceDict = {};
            data.forEach(row => {
                if (row.lot_number) {
                    const lot = String(row.lot_number).replace(/\.0$/, '');
                    const price = Math.round(row.price || 0);
                    const productionCost = Math.round(row['Production Cost'] || 0);
                    priceDict[lot] = {name: row.name, price: price, productionCost: productionCost};
                }
            });
        }

        function startListening() {
            if (isListening) return;
            isListening = true;
            document.getElementById('status').textContent = 'Прослушивание... Говори номер лота.';
            listenOnce();
        }

        function stopListening() {
            isListening = false;
            recognition.abort();
            document.getElementById('status').textContent = 'Прослушивание остановлено.';
        }

        function listenOnce() {
            recognition.start();
        }

        recognition.onresult = function(event) {
            const currentTime = Date.now();
            if (currentTime - lastResultTime < debounceTime) return;
            lastResultTime = currentTime;

            let text = event.results[event.results.length - 1][0].transcript.toLowerCase().replace('лот', '').trim();
            text = text.replace(/точка/g, '.');
            const words = text.split(/[\s-]/);
            let lotNumber = words.map(russianWordToNumber).join('.');
            document.getElementById('status').textContent = `Распознано: ${text} (очищено: ${lotNumber})`;

            if (lotNumber in priceDict) {
                const {name, price, productionCost} = priceDict[lotNumber];
                let response = `Лот ${lotNumber}: `;
                if (!document.getElementById('priceOnly').checked) {
                    response += `${name}. `;
                }
                response += ` ${price} рублей.`;
                let displayText = `Название лота: ${name}`;
                if (productionCost > price) {
                    speak('Внимание, производство дороже!!!');
                    setTimeout(() => speak(response), 1000);  // Пауза 1 сек
                    displayText += ` <span class="red">Production Cost: ${productionCost}</span>`;
                } else {
                    speak(response);
                }
                responseCount++;
                document.getElementById('lotDisplay').innerHTML = displayText;
            } else {
                speak(`Лот ${lotNumber} не найден.`);
                document.getElementById('lotDisplay').textContent = 'Лот не найден';
            }
        };

        recognition.onerror = function(event) {
            document.getElementById('status').textContent = 'Ошибка: ' + event.error;
            if (isListening && (event.error === 'no-speech' || event.error === 'audio-capture')) {
                setTimeout(listenOnce, 1000);
            }
        };

        recognition.onend = function() {
            if (isListening) {
                setTimeout(listenOnce, 1000);
            }
        };

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ru-RU';
            utterance.rate = parseFloat(document.getElementById('speechRate').value);
            speechSynthesis.speak(utterance);
        }

        function russianWordToNumber(word) {
            const map = {
                'ноль': '0', 'один': '1', 'два': '2', 'три': '3', 'четыре': '4', 'пять': '5',
                'шесть': '6', 'семь': '7', 'восемь': '8', 'девять': '9', 'десять': '10',
                // Добавь больше, если нужно
            };
            return map[word] || word;
        }

        function showModal() {
            document.getElementById('modal').style.display = "block";
        }

        function closeModal() {
            document.getElementById('modal').style.display = "none";
        }

        function vibrate() {
            if (navigator.vibrate) {
                navigator.vibrate(50);  // Вибрация 50 мс
            }
        }

        // Добавь vibrate к onclick кнопок
        document.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', vibrate);
        });
    </script>
</body>
</html>
